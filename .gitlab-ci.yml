image: python:3.8-slim-buster

before_script:
  - python --version
  - pip install ".[dev]"

stages:
 - Static Analysis
 - Test
 - Build
 - Publish

mypy:
  stage: Static Analysis
  script:
    - python -m mypy src/minio_keygen/*.py

flake8:
  stage: Static Analysis
  script:
    - flake8 --statistics --count --max-line-length=130 --max-complexity 8 src/minio_keygen/*.py

pylint:
  stage: Static Analysis
  script:
    - pylint -d C0301 src/minio_keygen/*.py

safety:
  stage: Static Analysis
  script:
    - safety check

pytest:
  stage: Test
  script:
    - py.test --verbose --junit-xml test-reports/results.xml
  artifacts:
    expire_in: 7 days
    paths:
      - test-reports

coverage:
  stage: Test
  allow_failure: true
  script:
    - pytest --cov minio_keygen

build:
  stage: Build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/*
    expire_in: 1 week

publish-dev:
  stage: Publish
  script:
    - pip install twine
    - twine check dist/*
    - twine upload --skip-existing --repository testpypi -u $PYPI_USERNAME -p $PYPI_PASSWORD dist/*
  only:
    - development
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
      allow_failure: true